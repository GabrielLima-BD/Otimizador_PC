import subprocess
import logging
import winreg
import os
from .utils import Utils

class PerformanceOptimizer:
    """Classe respons√°vel pelas otimiza√ß√µes de desempenho"""
    
    def __init__(self):
        self.logger = logging.getLogger(__name__)
        self.optimizations_applied = []
        
        # Servi√ßos que podem ser desabilitados para melhor desempenho
        # ‚ö†Ô∏è LISTA SEGURA DE SERVI√áOS - √ÅUDIO/MICROFONE PROTEGIDOS ‚ö†Ô∏è
        self.services_to_disable = [
            'WSearch',  # Windows Search
            'SysMain',  # Superfetch/Prefetch
            'Themes',   # Temas (se n√£o usar)
            'TabletInputService',  # Servi√ßo de entrada de tablet
            'WbioSrvc',  # Servi√ßo de biometria
            # 'WMPNetworkSvc' REMOVIDO - pode afetar √°udio
            'WerSvc',   # Relat√≥rio de erros do Windows
            'DiagTrack',  # Telemetria
            'RetailDemo',  # Servi√ßo de demonstra√ß√£o
            'RemoteAccess',  # Roteamento e acesso remoto
            'SharedAccess',  # Compartilhamento de conex√£o de internet
            'TrkWks',   # Cliente de rastreamento de link distribu√≠do
            'WpcMonSvc',  # Controle dos pais
        ]
        
        # üé§ SERVI√áOS PROTEGIDOS - NUNCA DESABILITAR (√ÅUDIO/MICROFONE)
        self.protected_audio_services = [
            'AudioSrv',           # Windows Audio
            'Audiosrv',           # Windows Audio (alternativo)
            'AudioEndpointBuilder',  # Windows Audio Endpoint Builder
            'RpcEptMapper',       # RPC Endpoint Mapper (necess√°rio para √°udio)
            'DcomLaunch',         # DCOM Server Process Launcher (necess√°rio para √°udio)
            'RpcSs',              # Remote Procedure Call (RPC) (necess√°rio para √°udio)
        ]
    
    def optimize_power_settings(self, progress_callback=None):
        """Configura plano de energia para m√°ximo desempenho"""
        if progress_callback:
            progress_callback("Configurando plano de energia...", 0)
        
        try:
            # Define plano de energia para alto desempenho
            cmd_high_performance = 'powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c'
            result1 = subprocess.run(cmd_high_performance, shell=True, capture_output=True, text=True)
            
            # Desabilita hiberna√ß√£o
            cmd_hibernate = 'powercfg -h off'
            result2 = subprocess.run(cmd_hibernate, shell=True, capture_output=True, text=True)
            
            # Configura para nunca desligar o disco
            cmd_disk = 'powercfg -change -disk-timeout-ac 0'
            result3 = subprocess.run(cmd_disk, shell=True, capture_output=True, text=True)
            
            # Configura para nunca entrar em suspens√£o
            cmd_standby = 'powercfg -change -standby-timeout-ac 0'
            result4 = subprocess.run(cmd_standby, shell=True, capture_output=True, text=True)
            
            if progress_callback:
                progress_callback("Plano de energia configurado", 100)
            
            self.optimizations_applied.append("Plano de energia otimizado")
            self.logger.info("Configura√ß√µes de energia otimizadas")
            return True
            
        except Exception as e:
            self.logger.error(f"Erro ao configurar energia: {e}")
            return False
    
    def disable_unnecessary_services(self, progress_callback=None):
        """üîí Desabilita servi√ßos desnecess√°rios - PROTE√á√ÉO DE √ÅUDIO ATIVA"""
        if progress_callback:
            progress_callback("Desabilitando servi√ßos desnecess√°rios...", 0)
        
        disabled_services = []
        total_services = len(self.services_to_disable)
        
        for i, service in enumerate(self.services_to_disable):
            if progress_callback:
                progress_callback(f"Verificando servi√ßo: {service}", (i / total_services) * 100)
            
            # üé§ PROTE√á√ÉO DE √ÅUDIO - Verificar se n√£o √© servi√ßo de √°udio
            if service.lower() in [s.lower() for s in self.protected_audio_services]:
                self.logger.info(f"üîí SERVI√áO DE √ÅUDIO PROTEGIDO: {service} - N√ÉO DESABILITADO")
                continue
            
            success = self._disable_service(service)
            if success:
                disabled_services.append(service)
        
        self.optimizations_applied.append(f"{len(disabled_services)} servi√ßos desabilitados")
        self.logger.info(f"Servi√ßos desabilitados: {disabled_services}")
        return disabled_services
    
    def _disable_service(self, service_name):
        """Desabilita um servi√ßo espec√≠fico"""
        try:
            # Para o servi√ßo
            cmd_stop = f'sc stop {service_name}'
            subprocess.run(cmd_stop, shell=True, capture_output=True, timeout=30)
            
            # Desabilita o servi√ßo
            cmd_disable = f'sc config {service_name} start= disabled'
            result = subprocess.run(cmd_disable, shell=True, capture_output=True, text=True, timeout=30)
            
            return result.returncode == 0
            
        except subprocess.TimeoutExpired:
            self.logger.warning(f"Timeout ao desabilitar servi√ßo: {service_name}")
            return False
        except Exception as e:
            self.logger.error(f"Erro ao desabilitar servi√ßo {service_name}: {e}")
            return False
    
    def disable_visual_effects(self, progress_callback=None):
        """Desabilita efeitos visuais para melhor desempenho"""
        if progress_callback:
            progress_callback("Desabilitando efeitos visuais...", 0)
        
        try:
            # Chave do registro para configura√ß√µes de desempenho visual
            key_path = r"CONTROL PANEL\Desktop"
            
            with winreg.OpenKey(winreg.HKEY_CURRENT_USER, key_path, 0, winreg.KEY_SET_VALUE) as key:
                # Desabilita anima√ß√µes de janelas
                winreg.SetValueEx(key, "UserPreferencesMask", 0, winreg.REG_BINARY, 
                                b'\x90\x12\x03\x80\x10\x00\x00\x00')
                
                # Desabilita drag full windows
                winreg.SetValueEx(key, "DragFullWindows", 0, winreg.REG_SZ, "0")
            
            # Configura√ß√µes avan√ßadas de sistema
            key_path2 = r"SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects"
            try:
                with winreg.CreateKey(winreg.HKEY_CURRENT_USER, key_path2) as key:
                    winreg.SetValueEx(key, "VisualFXSetting", 0, winreg.REG_DWORD, 2)  # Melhor desempenho
            except:
                pass
            
            if progress_callback:
                progress_callback("Efeitos visuais desabilitados", 100)
            
            self.optimizations_applied.append("Efeitos visuais otimizados")
            self.logger.info("Efeitos visuais desabilitados")
            return True
            
        except Exception as e:
            self.logger.error(f"Erro ao desabilitar efeitos visuais: {e}")
            return False
    
    def disable_indexing(self, progress_callback=None):
        """Desabilita indexa√ß√£o de arquivos em discos"""
        if progress_callback:
            progress_callback("Desabilitando indexa√ß√£o de discos...", 0)
        
        try:
            import string
            drives_processed = []
            
            # Obt√©m todas as unidades de disco
            available_drives = ['%s:' % d for d in string.ascii_uppercase if os.path.exists('%s:' % d)]
            
            for i, drive in enumerate(available_drives):
                if progress_callback:
                    progress_callback(f"Processando drive {drive}", (i / len(available_drives)) * 100)
                
                try:
                    # Comando para desabilitar indexa√ß√£o
                    cmd = f'fsutil behavior set DisableLastAccess 1'
                    subprocess.run(cmd, shell=True, capture_output=True, timeout=30)
                    
                    # Desabilita indexa√ß√£o do drive
                    cmd_drive = f'fsutil behavior set EncryptPagingFile 0'
                    subprocess.run(cmd_drive, shell=True, capture_output=True, timeout=30)
                    
                    drives_processed.append(drive)
                    
                except subprocess.TimeoutExpired:
                    continue
                except Exception:
                    continue
            
            if progress_callback:
                progress_callback("Indexa√ß√£o desabilitada", 100)
            
            self.optimizations_applied.append(f"Indexa√ß√£o desabilitada em {len(drives_processed)} drives")
            self.logger.info(f"Indexa√ß√£o desabilitada nos drives: {drives_processed}")
            return True
            
        except Exception as e:
            self.logger.error(f"Erro ao desabilitar indexa√ß√£o: {e}")
            return False
    
    def optimize_startup_programs(self, progress_callback=None):
        """Otimiza programas de inicializa√ß√£o"""
        if progress_callback:
            progress_callback("Otimizando programas de inicializa√ß√£o...", 0)
        
        try:
            # Lista de programas comuns que podem ser desabilitados na inicializa√ß√£o
            startup_disable_list = [
                'Skype',
                'Spotify',
                'Steam',
                'Adobe Updater',
                'QuickTime',
                'iTunes Helper',
                'Java Update',
                'Office',
            ]
            
            disabled_count = 0
            
            # Desabilita via registro
            startup_key = r"SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
            
            try:
                with winreg.OpenKey(winreg.HKEY_CURRENT_USER, startup_key, 0, winreg.KEY_ALL_ACCESS) as key:
                    i = 0
                    while True:
                        try:
                            name, value, type = winreg.EnumValue(key, i)
                            
                            # Verifica se √© um programa que deve ser desabilitado
                            for disable_prog in startup_disable_list:
                                if disable_prog.lower() in name.lower() or disable_prog.lower() in value.lower():
                                    try:
                                        winreg.DeleteValue(key, name)
                                        disabled_count += 1
                                        self.logger.info(f"Programa de inicializa√ß√£o removido: {name}")
                                        break
                                    except:
                                        pass
                            i += 1
                        except WindowsError:
                            break
            except:
                pass
            
            if progress_callback:
                progress_callback("Programas de inicializa√ß√£o otimizados", 100)
            
            self.optimizations_applied.append(f"{disabled_count} programas de inicializa√ß√£o desabilitados")
            return True
            
        except Exception as e:
            self.logger.error(f"Erro ao otimizar inicializa√ß√£o: {e}")
            return False
    
    def optimize_memory_management(self, progress_callback=None):
        """Otimiza gerenciamento de mem√≥ria"""
        if progress_callback:
            progress_callback("Otimizando gerenciamento de mem√≥ria...", 0)
        
        try:
            # Configura√ß√µes de mem√≥ria virtual
            key_path = r"SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management"
            
            with winreg.OpenKey(winreg.HKEY_LOCAL_MACHINE, key_path, 0, winreg.KEY_SET_VALUE) as key:
                # Desabilita paging executive
                winreg.SetValueEx(key, "DisablePagingExecutive", 0, winreg.REG_DWORD, 1)
                
                # Otimiza cache de sistema
                winreg.SetValueEx(key, "LargeSystemCache", 0, winreg.REG_DWORD, 1)
                
                # Configura√ß√£o de I/O page lock limit
                winreg.SetValueEx(key, "IoPageLockLimit", 0, winreg.REG_DWORD, 983040)
            
            if progress_callback:
                progress_callback("Gerenciamento de mem√≥ria otimizado", 100)
            
            self.optimizations_applied.append("Gerenciamento de mem√≥ria otimizado")
            self.logger.info("Configura√ß√µes de mem√≥ria otimizadas")
            return True
            
        except Exception as e:
            self.logger.error(f"Erro ao otimizar mem√≥ria: {e}")
            return False
    
    def disable_windows_defender_realtime(self, progress_callback=None):
        """Desabilita prote√ß√£o em tempo real do Windows Defender (CUIDADO!)"""
        if progress_callback:
            progress_callback("Configurando Windows Defender...", 0)
        
        try:
            # AVISO: Isso pode deixar o sistema vulner√°vel
            cmd = 'powershell -Command "Set-MpPreference -DisableRealtimeMonitoring $true"'
            result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=30)
            
            if result.returncode == 0:
                if progress_callback:
                    progress_callback("Windows Defender configurado", 100)
                
                self.optimizations_applied.append("Prote√ß√£o em tempo real do Defender desabilitada")
                self.logger.warning("AVISO: Prote√ß√£o em tempo real do Windows Defender desabilitada")
                return True
            else:
                return False
                
        except Exception as e:
            self.logger.error(f"Erro ao configurar Windows Defender: {e}")
            return False
    
    def optimize_processor_scheduling(self, progress_callback=None):
        """Otimiza agendamento do processador"""
        if progress_callback:
            progress_callback("Otimizando agendamento do processador...", 0)
        
        try:
            key_path = r"SYSTEM\CurrentControlSet\Control\PriorityControl"
            
            with winreg.OpenKey(winreg.HKEY_LOCAL_MACHINE, key_path, 0, winreg.KEY_SET_VALUE) as key:
                # Prioriza programas em primeiro plano
                winreg.SetValueEx(key, "Win32PrioritySeparation", 0, winreg.REG_DWORD, 38)
            
            if progress_callback:
                progress_callback("Agendamento do processador otimizado", 100)
            
            self.optimizations_applied.append("Agendamento do processador otimizado")
            self.logger.info("Agendamento do processador otimizado")
            return True
            
        except Exception as e:
            self.logger.error(f"Erro ao otimizar processador: {e}")
            return False
    
    def get_optimization_summary(self):
        """Retorna resumo das otimiza√ß√µes aplicadas"""
        return {
            'optimizations_count': len(self.optimizations_applied),
            'optimizations_list': self.optimizations_applied
        }